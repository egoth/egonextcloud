{
  debug
  auto_https disable_redirects
}

# Host esplicito su IP della macchina host
https://192.168.1.151 {
  tls {
    issuer internal
    # Inizia con TLS 1.2 per evitare l'alert interno; poi puoi aggiungere tls1.3
    protocols tls1.2
    # Genera e gestisci anche questi certificati (utile quando il client non manda SNI)
    certificates {
      automate 192.168.1.151
      automate 172.18.0.5
    }
    # Se la tua build di Caddy lo supporta, puoi aggiungere:
    # default_sni 192.168.1.151
  }

  # well-known essenziali
  handle_path /.well-known/carddav {
    redir /remote.php/dav 301
  }
  handle_path /.well-known/caldav {
    redir /remote.php/dav 301
  }
  handle_path /.well-known/webfinger {
    redir /index.php/.well-known/webfinger 301
  }
  handle_path /.well-known/nodeinfo {
    redir /index.php/.well-known/nodeinfo 301
  }

  # proxy a Nextcloud nel network Docker
  reverse_proxy nextcloud:80
}
